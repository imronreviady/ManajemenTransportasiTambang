@using ManajemenTransportasiTambang.Models
@model VehicleReservation
@{
    ViewData["Title"] = "Reservation Details";
}

<div class="mb-4 d-flex justify-content-between align-items-center">
    <h1 class="display-6 fw-bold">
        <i class="bi bi-info-circle"></i> Reservation Details
    </h1>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Reservation Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">ID</div>
                    <div class="col-md-8">@Model.Id</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Purpose</div>
                    <div class="col-md-8">@Model.Purpose</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Requester</div>
                    <div class="col-md-8">@Model.Requester?.FullName (@Model.Requester?.UserName)</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Department</div>
                    <div class="col-md-8">@Model.Requester?.Department</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Request Date</div>
                    <div class="col-md-8">@Model.RequestDate.ToString("MMM dd, yyyy HH:mm")</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Start Date</div>
                    <div class="col-md-8">@Model.StartDate.ToString("MMM dd, yyyy HH:mm")</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">End Date</div>
                    <div class="col-md-8">@Model.EndDate.ToString("MMM dd, yyyy HH:mm")</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Origin</div>
                    <div class="col-md-8">@Model.Origin</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Destination</div>
                    <div class="col-md-8">@Model.Destination</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Estimated Distance</div>
                    <div class="col-md-8">@Model.EstimatedDistance km</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Status</div>
                    <div class="col-md-8">
                        @switch (Model.Status)
                        {
                            case ReservationStatus.Pending:
                                <span class="badge bg-warning text-dark">Pending</span>
                                break;
                            case ReservationStatus.PartiallyApproved:
                                <span class="badge bg-info">Partially Approved</span>
                                break;
                            case ReservationStatus.Approved:
                                <span class="badge bg-success">Approved</span>
                                break;
                            case ReservationStatus.Rejected:
                                <span class="badge bg-danger">Rejected</span>
                                break;
                            case ReservationStatus.Completed:
                                <span class="badge bg-secondary">Completed</span>
                                break;
                            case ReservationStatus.Cancelled:
                                <span class="badge bg-dark">Cancelled</span>
                                break;
                        }
                    </div>
                </div>
                @if (Model.Status == ReservationStatus.Cancelled && !string.IsNullOrEmpty(Model.CancellationReason))
                {
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Cancellation Reason</div>
                        <div class="col-md-8">@Model.CancellationReason</div>
                    </div>
                }
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Notes</div>
                    <div class="col-md-8">@(string.IsNullOrEmpty(Model.Notes) ? "-" : Model.Notes)</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Vehicle Information</h5>
            </div>
            <div class="card-body">
                @if (Model.Vehicle != null)
                {
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">Registration</div>
                        <div class="col-md-7">@Model.Vehicle.RegistrationNumber</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">Brand</div>
                        <div class="col-md-7">@Model.Vehicle.Brand</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">Model</div>
                        <div class="col-md-7">@Model.Vehicle.Model</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">Type</div>
                        <div class="col-md-7">@Model.Vehicle.Type</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">Ownership</div>
                        <div class="col-md-7">@Model.Vehicle.Ownership</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">Capacity</div>
                        <div class="col-md-7">@Model.Vehicle.Capacity</div>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">Vehicle information not available</div>
                }
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">Driver Information</h5>
            </div>
            <div class="card-body">
                @if (Model.Driver != null)
                {
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">Name</div>
                        <div class="col-md-7">@Model.Driver.Name</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">License</div>
                        <div class="col-md-7">@Model.Driver.LicenseNumber</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">License Expiry</div>
                        <div class="col-md-7">@Model.Driver.LicenseExpiry.ToString("MMM dd, yyyy")</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-5 fw-bold">Phone</div>
                        <div class="col-md-7">@Model.Driver.PhoneNumber</div>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">Driver information not available</div>
                }
            </div>
        </div>
    </div>
</div>

@if (Model.Approvals != null && Model.Approvals.Any())
{
    <div class="card shadow mb-4">
        <div class="card-header bg-warning">
            <h5 class="card-title mb-0">Approval History</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Approver</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var approval in Model.Approvals.OrderBy(a => a.ApprovalLevel))
                        {
                            <tr>
                                <td>@approval.ApprovalLevel</td>
                                <td>@approval.Approver?.FullName</td>
                                <td>
                                    @switch (approval.Status)
                                    {
                                        case ApprovalStatus.Pending:
                                            <span class="badge bg-warning text-dark">Pending</span>
                                            break;
                                        case ApprovalStatus.Approved:
                                            <span class="badge bg-success">Approved</span>
                                            break;
                                        case ApprovalStatus.Rejected:
                                            <span class="badge bg-danger">Rejected</span>
                                            break;
                                    }
                                </td>
                                <td>@(approval.ApprovalDate?.ToString("MMM dd, yyyy HH:mm") ?? "-")</td>
                                <td>@(string.IsNullOrEmpty(approval.Comments) ? "-" : approval.Comments)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

<div class="d-flex gap-2 mb-4">
    @if (Model.Status == ReservationStatus.Pending || Model.Status == ReservationStatus.PartiallyApproved)
    {
        <a asp-action="Cancel" asp-route-id="@Model.Id" class="btn btn-danger">
            <i class="bi bi-x-circle"></i> Cancel Reservation
        </a>
    }
    
    @if (User.IsInRole("Admin") && Model.Status == ReservationStatus.Approved)
    {
        <a asp-action="Complete" asp-route-id="@Model.Id" class="btn btn-success">
            <i class="bi bi-check-circle"></i> Mark as Completed
        </a>
    }
    
    <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>
